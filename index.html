<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quem sou eu?</title>
  <style>
    :root{--card:#fff;--muted:#6b7280;--text:#111827;--brand:#111827;--ring:#11182722;--ok:#16a34a}
    html,body{height:100%}
    body{margin:0;background:#f5f7fb;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}
    .container{max-width:820px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:28px;text-align:center}
    .img-wrap{width:420px;max-width:90vw;aspect-ratio:1/1;margin:0 auto 16px;border-radius:14px;overflow:hidden;background:#eef0f6;border:1px solid #e5e7eb;display:grid;place-items:center}
    .img-wrap img{width:100%;height:100%;object-fit:cover;display:block}
    .title{font-weight:800;font-size:22px;margin:6px 0 12px}
    .muted{color:var(--muted);font-size:12.5px}
    .muted a{color:#374151;text-decoration:underline;cursor:pointer}
    form{margin-top:14px}
    .row{display:flex;gap:10px;justify-content:center}
    input[type="text"]{width:520px;max-width:72vw;padding:12px 14px;border-radius:10px;border:1px solid #e5e7eb;font-size:14.5px;outline:0;transition:box-shadow .15s,border-color .15s}
    input[type="text"]:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    button{padding:12px 18px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.55;cursor:not-allowed}
    .sent{margin-top:10px;color:var(--muted);font-size:12.5px;display:flex;align-items:center;gap:6px;justify-content:center}
    .sent.ok{color:var(--ok)}
    .rules{margin-top:28px;font-size:12.5px;color:#374151}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal{width:680px;max-width:95vw;background:#fff;border-radius:16px;padding:18px;box-shadow:0 15px 40px rgba(0,0,0,.25)}
    .modal h2{margin:0 0 8px;font-size:18px}
    .search{display:flex;gap:8px;margin-bottom:12px}
    .list{max-height:52vh;overflow:auto;border:1px solid #e5e7eb;border-radius:12px}
    .item{padding:10px 12px;border-bottom:1px solid #eef0f3;cursor:pointer;display:flex;justify-content:space-between;gap:8px}
    .item:last-child{border-bottom:0}
    .item:hover{background:#f6f8fb}
    .pill{font-size:11px;background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none;z-index:60}
    .helper{font-size:11.5px;color:#6b7280;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="region" aria-labelledby="title">
      <div class="img-wrap" id="imgWrap" aria-live="polite">
        <img id="photo" src="" alt="Foto da rodada" style="display:none" />
        <img id="loader" src="./loading.gif" alt="Carregando imagem" />
      </div>

      <div class="title" id="title">Quem sou eu?</div>

      <div class="muted" id="whoLine">
        Você está palpitando como <b id="whoName">–</b>
        · <a id="switchLink">trocar</a>
      </div>

      <form id="guessForm" autocomplete="off">
        <div class="row">
          <input id="guessInput" type="text" list="namesList" placeholder="Digite o nome de quem você acha que é" required />
          <button id="sendBtn" type="submit">enviar</button>
        </div>
        <datalist id="namesList"></datalist>
        <div class="helper">O autocompletar usa a mesma lista de colaboradores.</div>
      </form>

      <div id="sentInfo" class="sent" style="display:none">
        <span>✔</span> <span>Palpite enviado</span>
      </div>

      <div class="rules">
        <b>Pontuação:</b><br/>
        +5 para as <b>5 primeiras respostas corretas;</b><br/>
        +3 para as demais respostas corretas;<br/>
        +1 por participação (se errar).
      </div>
    </div>
  </div>

  <!-- Modal de seleção -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h2 id="modalTitle">Escolha seu nome</h2>
      <div class="search">
        <input id="searchBox" type="text" placeholder="Buscar por nome..." />
        <button class="btn" id="reloadColabs">Recarregar</button>
      </div>
      <div id="list" class="list" role="listbox" aria-label="Lista de colaboradores"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="closeModal">Cancelar</button>
        <button class="btn primary" id="confirmModal" disabled>Confirmar</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /* ===== CONFIG ===== */
    const API_BASE   = 'https://script.google.com/macros/s/AKfycbxQa8zEGfYoTK1og8QPtJeRynT4wMU4g86KpA2-bOkEJrj16c3_5IgNwHrCJvX_SBznyg/exec'; // ajuste aqui
    // GET  `${API_BASE}?route=current` -> { roundId, imageUrl }
    // POST `${API_BASE}?route=submit`  -> body { roundId, name, guess }
    const COLABS_URL = 'https://thaysresende.github.io/integracaotadt/colabs.json'; // relativo à mesma pasta

    /* ===== STORAGE KEYS ===== */
    const LS_USER = 'aq_user_name';
    const LS_GUESS = (rid, name) => `aq_guess:${rid}:${(name||'').toLowerCase()}`;

    /* ===== ELEMENTOS ===== */
    const $photo=document.getElementById('photo'), $loader=document.getElementById('loader');
    const $whoName=document.getElementById('whoName'), $whoLine=document.getElementById('whoLine'), $switchLink=document.getElementById('switchLink');
    const $guessForm=document.getElementById('guessForm'), $guessInput=document.getElementById('guessInput'), $sendBtn=document.getElementById('sendBtn');
    const $sentInfo=document.getElementById('sentInfo'), $toast=document.getElementById('toast'), $namesList=document.getElementById('namesList');
    const $backdrop=document.getElementById('modalBackdrop'), $list=document.getElementById('list'), $search=document.getElementById('searchBox');
    const $closeModal=document.getElementById('closeModal'), $confirmBtn=document.getElementById('confirmModal'), $reloadBtn=document.getElementById('reloadColabs');

    /* ===== ESTADO ===== */
    let roundId=null;
    let userName=localStorage.getItem(LS_USER)||'';
    let collaborators=[];
    let selectedName=userName||null;

    /* ===== UTIL ===== */
    function toast(msg, ms=2200){ $toast.textContent=msg; $toast.style.display='block'; setTimeout(()=> $toast.style.display='none', ms); }
    function setWhoLine(){ $whoName.textContent=userName||'—'; $whoLine.style.visibility=userName?'visible':'hidden'; }
    function setSentUI(sent){ $sentInfo.style.display=sent?'flex':'none'; $sendBtn.disabled=sent; $guessInput.disabled=sent; }
    function isAlreadySent(){ if(!roundId||!userName) return false; return localStorage.getItem(LS_GUESS(roundId, userName))==='1'; }
    function lockIfNeeded(){ setSentUI(isAlreadySent()); }
    function openModal(){ $backdrop.style.display='flex'; $backdrop.setAttribute('aria-hidden','false'); $search.value=''; renderList(); selectedName=userName||null; syncConfirm(); }
    function closeModal(){ $backdrop.style.display='none'; $backdrop.setAttribute('aria-hidden','true'); }
    function syncConfirm(){ $confirmBtn.disabled=!selectedName; }
    function renderList(){
      const q=($search.value||'').toLowerCase().trim();
      const items=collaborators.filter(n=>!q||n.toLowerCase().includes(q)).map(n=>{
        const div=document.createElement('div'); div.className='item'; div.setAttribute('role','option');
        div.innerHTML=`<span>${n}</span>${selectedName===n?'<span class="pill">Selecionado</span>':''}`;
        div.onclick=()=>{selectedName=n; renderList(); syncConfirm();};
        return div;
      });
      $list.replaceChildren(...(items.length?items:[Object.assign(document.createElement('div'),{className:'item',textContent:'Nenhum nome encontrado'})]));
    }
    function addNamesToDatalist(){
      $namesList.replaceChildren(...collaborators.map(n=>{const o=document.createElement('option'); o.value=n; return o;}));
    }
    function preLoadImg(url){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(url); i.onerror=rej; i.src=url; }); }

    /* ===== API ===== */
    async function fetchRound(){
      const res=await fetch(`${API_BASE}?route=current`,{cache:'no-store'});
      if(!res.ok) throw new Error('Falha ao carregar rodada');
      const data=await res.json();
      if(!data||!data.roundId) throw new Error('Resposta inválida');
      return data;
    }
    async function submitGuess({roundId,name,guess}){
      const res=await fetch(`${API_BASE}?route=submit`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({roundId,name,guess})
      });
      const data=await res.json().catch(()=> ({}));
      if(!res.ok||data.error) throw new Error(data.error||'Falha ao enviar palpite');
      return data;
    }
    async function fetchCollaborators(){
      const res=await fetch(COLABS_URL,{cache:'no-store'});
      if(!res.ok) throw new Error('Não foi possível carregar a lista de colaboradores');
      const list=await res.json(); if(!Array.isArray(list)) throw new Error('JSON deve ser um array de strings');
      collaborators=list; addNamesToDatalist();
    }

    /* ===== BOOT ===== */
    async function boot(){
      setWhoLine();
      try{ await fetchCollaborators(); }catch(e){ console.warn(e); toast('Aviso: lista de colaboradores indisponível.'); }

      try{
        const { roundId:rid, imageUrl } = await fetchRound();
        roundId=String(rid);
        setSentUI(false);
        if(isAlreadySent()) setSentUI(true);

        try{
          const ok=await preLoadImg(imageUrl);
          $photo.src=ok;
          $photo.style.display='block';
          $loader.style.display='none';  // esconde loading.gif
        }catch{
          // mantém o loading.gif visível
          toast('Carregando imagem da rodada…');
        }
      }catch(e){ console.error(e); toast('Erro ao carregar rodada.'); }

      if(!userName) openModal();
    }

    /* ===== EVENTOS ===== */
    document.getElementById('switchLink').onclick=(e)=>{e.preventDefault(); openModal();};
    $closeModal.onclick=()=> closeModal();
    $confirmBtn.onclick=()=>{ if(!selectedName) return; userName=selectedName; localStorage.setItem(LS_USER,userName); setWhoLine(); closeModal(); lockIfNeeded(); toast('Nome salvo.'); };
    $search.oninput=renderList;
    $reloadBtn.onclick=async ()=>{ $reloadBtn.disabled=true; try{ await fetchCollaborators(); renderList(); toast('Lista recarregada.'); }catch{ toast('Falha ao recarregar.'); } finally{ $reloadBtn.disabled=false; } };

    $guessForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const guess=$guessInput.value.trim();
      if(!guess) return;
      if(!$photo.src){ toast('Aguarde a imagem.'); return; }
      if(!userName){ openModal(); toast('Escolha seu nome.'); return; }
      if(!roundId){ toast('Rodada não carregada.'); return; }
      if(isAlreadySent()){ toast('Você já enviou palpite nesta rodada.'); return; }

      $sendBtn.disabled=true;
      try{
        const resp=await submitGuess({roundId,name:userName,guess});
        localStorage.setItem(LS_GUESS(roundId,userName),'1');
        setSentUI(true);
        toast(resp.isCorrect ? `Acertou! (+${resp.points})` : `Recebido! (+${resp.points})`);
      }catch(err){
        if(String(err.message||'').includes('já respondeu')){ localStorage.setItem(LS_GUESS(roundId,userName),'1'); setSentUI(true); }
        else{ $sendBtn.disabled=false; }
        toast(err.message||'Erro ao enviar palpite.');
      }
    });

    boot();
  </script>
</body>
</html>
